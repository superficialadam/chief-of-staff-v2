#!/bin/bash

# Setup Telegram webhook for the deployed app

set -e

echo "Setting up Telegram webhook..."

# Get bot token from 1Password
BOT_TOKEN=$(op read op://Dev/cos_app/telegram_bot_token)

if [ -z "$BOT_TOKEN" ]; then
  echo "Error: Could not retrieve TELEGRAM_BOT_TOKEN from 1Password"
  exit 1
fi

# Set webhook URL
WEBHOOK_URL="https://cos.dev.its75am.com/cos"

echo "Configuring webhook: $WEBHOOK_URL"

# Call Telegram API
response=$(curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/setWebhook" \
  -H "Content-Type: application/json" \
  -d "{\"url\": \"$WEBHOOK_URL\"}")

# Parse response
if echo "$response" | grep -q '"ok":true'; then
  echo "✅ Webhook successfully configured!"
  echo "Response: $response"
else
  echo "❌ Failed to set webhook"
  echo "Response: $response"
  exit 1
fi

echo ""
echo "Your Telegram bot is now connected to: $WEBHOOK_URL"
echo "Send a message to your bot to test it!"